

# β… Chapter 3: Advanced Request-Reply Patterns (κ³ κΈ‰ μ”μ²­-μ‘λ‹µ ν¨ν„΄)

> λ‹¨μν• `REQ-REP` ν¨ν„΄μ„ λ„μ–΄μ„ λ‹¤μ–‘ν• λΌμ°ν…/λΉ„λ™κΈ° ν¨ν„΄μ„ μ–΄λ–»κ² κµ¬ν„ν•  μ μλ”μ§€λ¥Ό λ‹¤λ£Ήλ‹λ‹¤.

---

## π“ λ‹¤λ£° λ‚΄μ©

- REQμ ν•κ³„μ™€ λ¬Έμ μ 
- DEALER-ROUTER ν¨ν„΄
- λΉ„λ™κΈ° μ”μ²­/μ‘λ‹µ κµ¬ν„
- λ©”μ‹μ§€ ID λ° λΌμ°ν… κ΄€λ¦¬
- μ»¤μ¤ν…€ λΌμ°ν„° κµ¬ν„
- Multipart λ©”μ‹μ§€μ μ‘μ©

---

## π« REQ-REPμ ν•κ³„

### π’΅ μ„¤λ…

κΈ°λ³Έ `REQ-REP` κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™μ€ **μ μ•½**μ΄ μμµλ‹λ‹¤:

1. **λ™κΈ° κµ¬μ΅°**  
   - `REQ`λ” λ°λ“μ‹ `send()` β†’ `recv()` μμ„λ¥Ό μ§€μΌμ•Ό ν•λ©°, λ°λ€λ΅ `REP`μ€ `recv()` β†’ `send()` μμ„λ§ ν—μ©λ©λ‹λ‹¤.
   - μ”μ²­μ„ λ³΄λ‚Έ λ’¤ μ‘λ‹µμ„ κΈ°λ‹¤λ¦¬κΈ° μ „μ—λ” **λ‹¤λ¥Έ μ”μ²­μ„ λ³΄λ‚Ό μ μ—†μµλ‹λ‹¤.**

2. **λ³‘λ ¬ μ²λ¦¬κ°€ λ¶κ°€λ¥**  
   - ν•λ‚μ `REP` μ†μΌ“μ€ ν• λ²μ— ν•λ‚μ μ”μ²­λ§ μ²λ¦¬ν•©λ‹λ‹¤.  
   - λ™μ‹μ— λ“¤μ–΄μ¤λ” μ”μ²­μ€ μμ°¨μ μΌλ΅ μ²λ¦¬λμ–΄μ•Ό ν•λ©°, λ€κΈ°μ—΄μ΄ μ“μ΄κ² λ©λ‹λ‹¤.

3. **λΌμ°ν… μ μ–΄ λ¶κ°€**  
   - λ©”μ‹μ§€κ°€ μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° μ™”λ”μ§€ μ§μ ‘ μ• μ μ—†μµλ‹λ‹¤.
   - νΉμ • ν΄λΌμ΄μ–ΈνΈλ΅ μ„ νƒμ μΌλ΅ μ‘λ‹µμ„ λ³΄λ‚΄λ” κ²ƒλ„ λ¶κ°€λ¥ν•©λ‹λ‹¤.

β΅οΈ μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν• κ³ κΈ‰ ν¨ν„΄μ΄ ν•„μ”ν•©λ‹λ‹¤.

---

## π§© DEALER-ROUTER ν¨ν„΄

> β… `REQ-REP`μ„ μ™„μ „ν λΉ„λ™κΈ° κµ¬μ΅°λ΅ ν™•μ¥ν• ν¨ν„΄μ…λ‹λ‹¤.  
> β… λΌμ°ν…, μ‘λ‹µ λ¶„κΈ°, λ©€ν‹°ν΄λΌμ΄μ–ΈνΈ λ€μ‘μ— κ°•λ ¥ν• κµ¬μ΅°λ¥Ό μ κ³µν•©λ‹λ‹¤.

---

### π ROUTER μ„λ²„ μμ  (λ©€ν‹° ν΄λΌμ΄μ–ΈνΈ λΌμ°ν…)

```python
import zmq

ctx = zmq.Context()
socket = ctx.socket(zmq.ROUTER)
socket.bind("tcp://*:5555")

while True:
    # multipart λ©”μ‹μ§€ μμ‹ : [client_id, empty, content]
    msg = socket.recv_multipart()
    client_id, _, content = msg
    print(f"From {client_id}: {content.decode()}")

    # ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό ν¬ν•¨ν•μ—¬ μ‘λ‹µ
    socket.send_multipart([client_id, b'', b'ACK'])
```

---

### π DEALER ν΄λΌμ΄μ–ΈνΈ μμ  (λΉ„λ™κΈ° ν΄λΌμ΄μ–ΈνΈ)

```python
import zmq

ctx = zmq.Context()
socket = ctx.socket(zmq.DEALER)
socket.connect("tcp://localhost:5555")

# λ©”μ‹μ§€ μ „μ†΅ (λΉ ν”„λ μ„ μƒλµ κ°€λ¥)
socket.send(b"Hello ROUTER")

# λ©”μ‹μ§€ μμ‹ 
reply = socket.recv()
print("Reply:", reply.decode())
```

---

### π’΅ μ„¤λ…

- `ROUTER`λ” ν΄λΌμ΄μ–ΈνΈ IDλ¥Ό κΈ°λ°μΌλ΅ λΌμ°ν…μ„ μν–‰ν•  μ μμµλ‹λ‹¤.
- `DEALER`λ” μμ„ μ ν•μ΄ μ—†μ–΄, `send()`, `send()`, `recv()`λ„ κ°€λ¥ν•©λ‹λ‹¤.
- λ©”μ‹μ§€λ” ν•­μƒ **Multipart**λ΅ μ „μ†΅λ©λ‹λ‹¤:
  - `ROUTER`: `[client_id, "", message]`
  - `DEALER`: `[message]` or `[empty, message]` ν•μ‹

---

## π§  λ©”μ‹μ§€ νλ¦„ μ΄ν•΄ν•κΈ°

### ROUTER μμ‹  λ©”μ‹μ§€ κµ¬μ΅°

```text
[client_id, empty_frame, message_content]
```

- `client_id`: ROUTERκ°€ ν΄λΌμ΄μ–ΈνΈλ¥Ό κµ¬λ¶„ν•κΈ° μ„ν• μ£Όμ†κ°’
- `empty_frame`: λ©”μ‹μ§€μ™€ μ£Όμ†μ κµ¬λ¶„μ (ν•„μ!)
- `message_content`: μ‹¤μ  λ©”μ‹μ§€ λ°μ΄ν„°

β΅οΈ ROUTERλ” λ°λ“μ‹ `client_id`λ¥Ό κΈ°μ–µν•κ³ , μ‘λ‹µ μ‹ **κ°™μ€ IDλ΅ μ‘λ‹µ**ν•΄μ•Ό ν•©λ‹λ‹¤.

---

## π” λΉ„λ™κΈ° μ‘λ‹µ μ²λ¦¬

### μ: μ—¬λ¬ μ”μ²­ μ²λ¦¬ ν›„ μμ„ μ—†μ΄ μ‘λ‹µ

```python
# ROUTER server μμ‹
import zmq, time

ctx = zmq.Context()
router = ctx.socket(zmq.ROUTER)
router.bind("tcp://*:5555")

while True:
    identity, _, request = router.recv_multipart()
    print(f"Received from {identity}: {request.decode()}")

    time.sleep(2)  # μ²λ¦¬ μ§€μ—° μ‹λ®¬λ μ΄μ…
    router.send_multipart([identity, b'', b'Response after delay'])
```

β΅οΈ μμ°¨ μ‘λ‹µμ΄ μ•„λ‹, **λΉ„λ™κΈ° μ‘λ‹µ μ²λ¦¬ κ°€λ¥**  
β΅οΈ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ λ™μ‹μ— λ°›μ•„ μμ„ μ—†μ΄ μ‘λ‹µν•  μ μμµλ‹λ‹¤.

---

## π“¦ Multipart λ©”μ‹μ§€ ν™μ©

- ROUTER/DEALER ν¨ν„΄μ€ κΈ°λ³Έμ μΌλ΅ **multipart λ©”μ‹μ§€** κΈ°λ°μ…λ‹λ‹¤.
- λ©”μ‹μ§€μ— `λ©”νƒ€ μ •λ³΄ + λ³Έλ¬Έ`μ„ ν•¨κ» μ‹¤μ„ μ μμ

```python
# μμ‹: λ©”νƒ€ + λ³Έλ¬Έ
socket.send_multipart([b'META:userid=1234', b'Hello World'])
```

```python
meta, body = socket.recv_multipart()
print("Meta:", meta.decode())
print("Body:", body.decode())
```

---

## π›  μ»¤μ¤ν…€ λΌμ°ν„° μ‘μ©

> λ‹¤μκ³Ό κ°™μ€ μ‘μ©μ΄ κ°€λ¥ν•΄μ§‘λ‹λ‹¤:

- νΉμ • μ‚¬μ©μμ—κ²λ§ μ‘λ‹µ λ³΄λ‚΄κΈ°
- μ”μ²­μ„ νμ— λ„£κ³ , μ›μ»¤μ—κ² λ¶„μ‚° μ²λ¦¬
- μ‘λ‹µμ„ λΌμ°ν… ν…μ΄λΈ”μ— λ”°λΌ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚΄κΈ°
- REQ-REP κµ¬μ΅°λ¥Ό μ‚¬μ©ν•μ§€ μ•κ³ λ„ λ‹¤μ–‘ν• λΉ„λ™κΈ° ν”„λ΅ν† μ½ μ„¤κ³„ κ°€λ¥

---

## π“ μ”μ•½ λΉ„κµ

| ν¨ν„΄           | κµ¬μ΅°        | νΉμ§•                         | μ μ¤μΌ€μ΄μ¤                              |
|----------------|-------------|------------------------------|------------------------------------------|
| REQ-REP        | 1:1         | λ™κΈ°, μμ„ μ ν•               | κ°„λ‹¨ν• RPC, κΈ°λ³Έ μ”μ²­/μ‘λ‹µ                |
| DEALER-ROUTER  | N:N         | μ™„μ „ λΉ„λ™κΈ°, λΌμ°ν… κ°€λ¥       | λΌμ°ν… μ„λ²„, λ©”μ‹μ§€ λΈλ΅μ»¤, Load Balancer |

---

## π“ μ°Έκ³ 

- `DEALER`μ™€ `ROUTER`λ” κΈ°λ³Έμ μΌλ΅ **λΉ„λ™κΈ°** ν†µμ‹ μ„ μ—Όλ‘μ— λ‘” κµ¬μ΅°μ…λ‹λ‹¤.
- `ROUTER`λ” ν΄λΌμ΄μ–ΈνΈλ¥Ό λ…μ‹μ μΌλ΅ μ‹λ³„ν•κ³  μ§μ ‘ μ‘λ‹µμ„ λ³΄λ‚Ό μ μμµλ‹λ‹¤.
- κ³µμ‹ λ¬Έμ„: [https://zguide.zeromq.org](https://zguide.zeromq.org)